## 中断

中断使cpu当前指令执行，转而执行中断程序。

如果没有中断程序。那么cpu只能按照固定的流程执行程序，无法响应例如鼠标、键盘、系统调用等



## 软中断

程序指令触发中断，例如syscall int 0x80。系统调用都会触发中断。

软中断分为陷阱、故障、终止。 

- 系统调用属于陷阱，故意中断。
- 缺页属于故障。
- 终止是指令执行过程发生致命错误。直接终止程序，例如栈溢出、访问异常地址。

例如：

当调用malloc()函数触发中断并执行操作系统代码时，会经历以下流程：

用户态程序调用malloc()：用户态程序通过调用malloc()函数来请求分配内存。malloc()函数是C标准库中的一个函数，用于动态分配内存。

触发中断：malloc()函数内部会调用操作系统提供的底层内存分配函数（如brk()或mmap()）。这些底层函数会触发一个中断，将CPU从用户态切换到内核态。

保存现场：在中断处理过程中，CPU会自动保存当前的执行上下文，包括寄存器值、程序计数器等。这样，在中断处理完成后，CPU可以恢复到中断前的状态，继续执行用户态程序。

中断处理：操作系统内核接收到中断请求后，会根据中断向量表找到对应的中断处理程序。对于内存分配请求，中断处理程序通常是内存管理模块的一部分。

执行内存分配操作：内存管理模块会根据请求的内存大小和当前内存使用情况来决定如何分配内存。这可能涉及到查找空闲内存块、分配新的内存页等操作。

更新内存管理数据结构：内存分配完成后，操作系统需要更新内存管理数据结构，如页表、空闲内存列表等，以反映新的内存分配情况。

恢复现场：在中断处理程序执行完毕后，CPU会恢复之前保存的执行上下文，包括寄存器值、程序计数器等。

返回用户态：CPU从内核态切换回用户态，继续执行用户态程序。

返回分配的内存地址：malloc()函数返回分配到的内存地址给用户态程序。用户态程序可以使用这个地址来访问和操作分配到的内存。

总之，调用malloc()触发中断并执行操作系统代码的流程包括用户态程序调用malloc()、触发中断、保存现场、中断处理、执行内存分配操作、更新内存管理数据结构、恢复现场、返回用户态和返回分配的内存地址等步骤。这些步骤共同保证了内存分配操作的正确性和高效性。



## 硬中断

键盘、鼠标等通过电信号触发硬中断，cpu保存上下文后查找中断向量表，执行中断程序。然后恢复上下文继续执行。

硬中断分为 可屏蔽的中断和不可屏蔽的中断。