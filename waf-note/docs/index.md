# 介绍
欢迎！在这里，我将分享关于WAF（Web应用防火墙）产品底层实现的知识和经验。

WAF是一种保护Web应用程序免受恶意攻击的安全解决方案。
它不仅可以阻止各种基于HTTP协议的安全漏洞，如SQL注入、跨站脚本等。
还可以识别并限制自动化程序的访问行为，例如防止恶意秒杀、恶意爬虫等。

从产品底层实现的角度，WAF主要分为`流量接入转发模块`、`流量检测分析模块`。

在WAF产品中，我主要参与了以下项目：

## 流量接入和转发项目
- 1.基于腾讯云负载均衡产品`CLB`和开源应用层负载均衡`nginx`搭建了高性能流量接入和转发集群，目前全地域承载流量1500wQPS。
- 2.基于公司内部`TKE-k8s`平台，优化集群设计方案，集群全面上云，大幅降低集群使用成本。
- 3.设计了集群过载保护能力和逃生能力，提升了集群的稳定性


并。，。。稳定性事故（--todo 使用具体数据突出高并发QPS和稳定性[135过载保护和逃生机制]）--todo降低成本，提升可扩展性，方便运维）
- 使用`golang`构建安全检测路由服务，将安全引擎调用方式从串行优化为并发调用。（--todo突出高并发和延时降低，QPS多少，p9999延时从xx降低到xx）
- 基于`Kafka`、`Flink`、`XGBoost`实现BOT检测.(--todo突出高并发、低误报)
- 基于`ElasticSearch`和`ClickHouse`实现流量分析和统计功能。（--todo大数据分析报表）
- 基于公司内部RPC框架`TRPC-golang`、`redis stream`、`mysql`搭建用户配置下发和对账服务，实现全链路监控、远程日志、实时告警。（--todo全面监控，快速定位问题）


## 控制面
控制面服务主要功能为：同步前端用户的接入配置和防护配置到WAF引擎节点并实时生效。
出于稳定性考虑，WAF引擎节点使用落盘的NGINX配置文件作为接入配置转发

技术上主要是涉及：

- 使用腾讯自研微服务框架TRPC构建控制面服务，提供全面的告警监控、远程日志、全链路追踪能力
- 使用redis存储防护配置，利用redis stream构建消息下发通道，
- mysql
- 安全编码（包含防SQL注入、防SSRF攻击等）

难点在于无死角对控制面程序进行全链路监控、日志审计、告警监控，从而快速排查和定位用户在配置上的问题，例如配置没有下发成功、下发版本错误等问题。


## 接入模块
接入模块的主要功能为：

- 提供多种接入形态，包括透明接入和串行接入。透明接入利用旁路转发流量到WAF，WAF返回安全检查结果。
- 打通多种接入SDK，包括CNAME接入、腾讯云CLB自动接入、微信小程序网关自动接入。

技术上主要涉及：

`串行接入`
WAF串联在用户网络链路中。用户利用DNS解析道WAF，由WAF检查流量并回源。技术上主要涉及网络转发，难点在于稳定性：

- 流量接入引擎（NGINX、LUA-NGINX-MODULE、OPENSSL）
- 计算机网络（IPV4/IPV6接入、TGW三层LVS转发、四层健康检查、七层负载均衡）
- 过载保护
- 一键逃生


``