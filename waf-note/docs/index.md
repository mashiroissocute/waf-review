## 项目总结




### 防护引擎性能优化

#### 问题
一个请求到达WAF后，会经过cc检测、bot检测、规则匹配、ai检测等多个检测模块。
当前检测架构是nginx收到请求之后，通过lua-nginx-module串行发起请求，依次将请求发送到各个检测模块。wrk压测情况，4c8g，3000QPS，串行检测的p9999检测延时为178ms。时延较长，不满足60ms的目标。分析问题，主要是因为串行检测，检测时延累加导致较长时延。因此，制定了串行检测改并发检测的优化方案。

#### 方案选型：

1.直接在lua-nginx-module中串行改并发调用下游检测模块
2.新增路由组件，从lua-nginx-module接受检测请求后，分发到下游多个检测模块，汇总结果后放回给lua-nginx-module。

方案选型中考虑的问题：

- 时延
- 成本
- 性能
- 可观测性
- 架构清晰度


#### demo阶段

sleep模拟下游调用
性能很好满足要求
2wqps p99 10ms

#### 开发阶段

基于
- 可读性
- 可扩展性
- 可观测性
开发代码


#### 性能优化
加入真正的下游请求之后只能压到1wqps并且p99时延120ms

##### wrk
打点分析耗时（或者pprof），发现主要耗时在与json序列化和请求下游收发包

###### json序列化的优化
benchmark测试
- fastjson
- 自己写json序列化
- snoicjson

p99整体时延128ms优化到80ms

###### 下游收发包慢问题

- 从net/http库切换到fasthttp库优化

p99整体时延128ms优化到40ms

###### 偶尔长尾延时高
p9999长尾延时258ms，怀疑到是gc问题

- 优化gc触发策略 ballast gcpercent
- 模仿fasthttp优化内存分配方案 逃逸分析 对象池化

##### 线上流量高峰问题

- 连接数打满，没有新流量进来。

rs表现为建立连接失败
hub变现为连接数非常高，cpu利用率和内存利用率非常低


因为cpu和内存利用率低，无法触发自动扩容策略。所以只能先手动扩容解决。

因为扩容速度很慢不够及时，rs一直处于建立连接失败状态并且一直重试，请求处理很慢导致rs cpu负载很高，rs也接近崩溃状态。
所以开始新建hub集群，在rs上通过切换北极星进行流量调度。勉强稳住了rs的整体情况。


问题排查：连接不能正确释放问题，导致连接数打满后释放连接缓慢。

因为已经处理无法新建连接的情况，无法利用新的请求去跑pprof来定问题。
所以先加上了pprof，等到下次流量高峰复现问题。

最终发现框架函数lockslow耗时长，这是一个拿锁删除连接的函数。

因为下游大量超时导致主动断开连接同时清理连接，调用lockslow获取connectionid释放连接，大量并发导致锁竞争。释放连接非常缓慢。导致waitgroup无法返回，rs的请求也无法返回，hub的连接池满了，rs到hub也无法新建连接。

解决方法：自己控制业务超时时间，强制返回结果，让waitgroup返回。让rs可以和hub新建连接，触发扩容机制。


