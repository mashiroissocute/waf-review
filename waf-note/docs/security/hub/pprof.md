## 1 前言
低时延、高并发的程序性能优化主要从cpu(业务代码执行效率)、内存(内存使用效率、gc损耗)、I/O(网络事件处理耗时)等方面入手。

在HUB中，优化手段主要有:

- 针对CPU的优化有: 协程池、json库选型
- 针对内存的优化有: 协程池、对象池、ballast、函数参数传递方式
- 针对I/O的优化有: http库选型

## 2 工具

### 2.1 BenchmarkTest
基准测试是测量一个程序在固定工作负载下的性能，Go语言也提供了可以支持基准性能测试的benchmark，为了在本地验证代码优化后的性能提升效果，往往需要针对优化的函数通过基准测试验证优化效果。

详见[benchmark_Test](../../basic/golang/benchmark.md)

### 2.2 wrk2
[wrk2](../../basic/test/wrk.md)


### 2.3 pprof
Profiling 是指在程序的执行过程中，收集能反映程序执行状态的数据，例如程序执行所占用内存、特定指令的使用情况或函数调用的频率和持续时间，等等。Profiling 最常见的应用就是帮助应用程序定位和优化性能问题。

详见[pprof](../../basic/golang/pprof.md)


## 3 优化的流程

- 1.建立评估指标: 4c8g，旁路全开。客户请求3000QPS，p9999控制到60ms以内

- 2.优化流程: (wrk压测到无法满足性能要求) --> (寻找性能瓶颈) --> (代码优化) --> (Benchmark测试验证优化效果) --> (wrk压测到无法满足性能要求)


## 4 优化方法

### 4.1 GC/内存优化

[GC/内存优化](./mem_pprof.md)

### 4.2 代码执行速度优化
[代码执行速度优化](./speed_pprof.md)

### 4.3 I/O网络库优化
[I/O优化](./io_pprof.md)



## 5 程序上线方法

### 5.1 上线前

- 压测：我们通过压测可以获知系统的性能，例如每秒能处理的请求数，平均响应时间，错误率等指标。这样，我们对自己服务的性能算是有个底。

- 问题：但是压测是线下的模拟流量，如果到了线上呢？会遇到高并发、大流量，不靠谱的上下游，突发的尖峰流量等等场景，这些都是不可预知的。

### 5.2 上线后
线上突然大量报警，接口超时，错误数增加

- 终极解决方案：看日志、看监控；使用性能分析工具分析程序的性能，找到瓶颈
- 临时解决方案：首先要降级、限流、回滚，先止损


### 5.3总结
性能分析很重要，尤其是要统计好性能数据，出问题了，可以随时拿出来看。


